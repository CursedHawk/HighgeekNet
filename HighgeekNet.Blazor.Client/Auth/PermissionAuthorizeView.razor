@using HighgeekNet.Common.Permissions
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IAuthorizationService _authorizationService

@if (IsAuthorized == null)
{
    @Loading
}
else if (IsAuthorized == true)
{
    @Authorized
}
else
{
    @NotAuthorized
}

@code {
    [Parameter] public RenderFragment? Authorized { get; set; }
    [Parameter] public RenderFragment? NotAuthorized { get; set; }
    [Parameter] public RenderFragment? Loading { get; set; }
    [Parameter] public string? Permission { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private bool? IsAuthorized;

    protected override async Task OnParametersSetAsync()
    {
        var auth = await AuthStateTask;
        var user = auth.User;

        if (!string.IsNullOrEmpty(Permission))
        {
            var res = await _authorizationService.AuthorizeAsync(user, null, new PermissionsAuthorizeAttribute(Permission));
            IsAuthorized = res.Succeeded;
            return;
        }
        IsAuthorized = false;
    }
}